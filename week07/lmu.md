# 12장 안티-엔트로피와 배포

- 클러스터 관련 메타데이터:
  - 클러스터의 구성과 상태, 장애 발생 여부, 스키마 변경
  - 크기가 작고 자주 전송되지 않지만 빠르고 안정적으로 전파돼야 한다.
- 메시지를 클러스터 내의 모든 노드로 전파하는 3가지 방법:
  - 하나의 프로세스가 모든 노드에 메시지를 브로드캐스트한다.
  - P2P 방식으로 주기적으로 정보를 교환한다. 노드는 쌍으로 연결해 메시지를 교환한다.
  - 모든 수신자가 협력해 메시지를 브로드캐스트한다. 더 빠르고 안정적으로 전파할 수 있다.
- 엔트로피: 시스템의 무질서를 나타내는 속성, 분산 시스템에서 엔트로피는 노드 사이의 불일치 정도를 나타낸다.
- 안티-엔트로피 메커니즘: 기본 전송이 실패했을 때 노드를 최신 상태로 동기화한다.:
  - 백그라운드: 머클 트리
  - 포그라운드: 힌트 핸드오프, 일기 복구, 피기백 방식의 메커니즘

## 읽기 복구
- 읽기 복구: 코디네이터는 낙관적으로 모든 복제본이 동기화된 상태라고 가정하고 분산 저장된 데이터를 읽고, 일치하지 않을 경우 누락된 변경사항을 해당 복제노드로 전송한다.
- 다이나모 방식의 일부 데이터베이스는 모든 복제 노드에 질의하지 않고 시스템의 일관성 수준을 조정한다.
- 읽기 복구는 블로킹 작업 또는 비동기 작업으로 구현할 수 있다.
- 블로킹 읽기 복구는 쿼럼의 단조읽기를 보장한다. 시스템의 가용성이 낮아진다.
- 일부 데이터베이스는 특수한 반복자와 병합 리스너를 사용해 복제본 사이에 정확히 어떤 레코드가 누락됐는지 파악한다.

## 다이제스트 읽기
- 로컬 데이터의 해시값을 반환해 코디네이터는 동기화된 상태를 확인한다.

## 힌트 핸드오프
- 쓰기 중 상태를 복구하는 안티-엔트로피 메커니즘을 뜻한다.
- 노드가 복구되면 코디네이터 또는 복제 노드에 기록된 특수 힌트 레코드를 참조해 쓰기를 재시도 한다.
- 카산드라는 일관성 레벨을 ANY로 하지 않은 경우 힌트레코드는 복제 팩터에 포함되지 않는다.
- 힌트 레코드는 읽을수 없고 뒤쳐진 노드를 최신 상태로 업데이트하는 용도로만 사용된다.
- 리악은 슬로피쿼럼과 힌트 핸드오프 방식을 사용한다.
- 슬로피 쿼럼 방식은 일부 복제 노드에 장애가 발생한 경우 전체 노드 목록에서 다시 정상 노드를 선택해 읽기를 수행한다. 반드시 연산의 대상 노드를 선택하지 않아도 된다.
- 슬로피 쿼럼은 고가용성을 위해 일관성을 포기한다.

## 머클 트리
- 자주 요청되지 않는 데이터 사이의 불일치 감지와 복구에는 다른 메커니즘이 필요하다.
- 데이터를 컴팩트한 해시 형태로 변환해 로컬에 저장하는 자료구조
- 계층적 형태로 구축해서 서브트리 단위로 내려가서 비교 범위가 줄어든다.
- 최하위 레벨부터 상향식으로 해시를 계산하기 때문에 데이터가 변경되면 해당 서브트리를 다시 계산해야한다.

## 비트맵 버전 벡터
- 최근성을 기반으로 데이터 사이의 불일치를 해결한다.
- 각 노드는 로컬에서 수행한 작업과 다른 노드에서 복제한 데이터에 대한 로그를 저장한다.
- 각 노드의 복제본의 상태는 노드별 논리적 클럭을 사용해 추적해야한다.
- 쓰기 작업 사이의 인과관계와 노드 사이에 누락된 데이터를 정확히 파악할수 있지만, 일부 노드에 장애가 발생하게 되면, 데이터가 아직 장애 노드들에 복제되는 중이기 때문에 이들이 복구될 때까지 다른 노드들은 로그를 삭제할 수 없다.

## 가십 전파
- 브로드캐스트의 전파력과 안티-엔트로피의 신뢰성
- 하나의 프로세스에서 클러스터 전체로 정보를 협동해서 전파한다.
- 가십  프로토콜은 노드가 클러스터 내에 단기적으로 존재하고 토폴로지에 포함되지 않는 동질적 탈 중앙 시스템에서 비동기적으로 메시지를 전달할 때 사용할 수 있다.
- 직접적인 코디네이션이 필요 없어 노드가 자유롭게 추가 및 제거되는 시스템 ㅗㄸ는 메시 네트워크에서 유용할 수 있다.

## 가십 메커니즘
- 메시지 중복성
- 수렴: 전파가 더이상 되지 않는 시점
- 가십 프로토콜은 수렴적 일관성을 보장한다. 더 과거에 발생한 이벤트일수록 모든 노드에 전파됐을 확률이 높다.

## 오버레이 네트워크
- 가십 시스템 내의 임시로 고정된 토폴로지를 정의하는 방법: 오버레이 네트워크를 구성한다.
- 시스템 토폴로지는 스패닝 트리를 사용해 표현할 수 있다.

## 혼합형 가십 프로토콜
- 플럼트리는 가십 기반 전파 방식과 트리 기반 브로드캐스트 방식을 모두 사용하는 혼합형 가십 프로토콜이다.
- 사용량이 일정한 네트워크에서 레이지 푸시 메커니즘을 사용해 트리를 구성 및 재구성하면 가장 먼저 응답하는 노드가 브로드캐스트에 추가되기 때문에  메시지 레이턴시를 최소화할수 있다.

## 부분 뷰
- 메시지 브로드캐스트는 노드 이탈률이 높을 수록 더 비효율적이다.
- 가십 프로토콜은 노드 이탈ㅇ률을 줄이기 위해서 샘플링 서비스를 사용한다.

