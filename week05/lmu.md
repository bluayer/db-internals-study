# 2 부 분산 시스템

- 저장 공간, 성능, 가용성을 높이기 위해서 클러스터가 필수적이다.
- 기본 정의:
  - 분산 알고리즘의 용도:
    - 코디네이션(Coordination): 여러 워커의 행동과 행위를 총괄한다.
    - 협동(Cooperation): 작업을 완료하기 위해 여러 참가자가 서로 협동한다.
    - 전파(Disemination): 프로세스는 정보를 필요로 하는 참가자에 신속하고 안정적으로 정보를 전파한다.
    - 합의(Consensus): 여러 프로세스 사이의 합의를 도출한다.

## 8장 분산시스템 개요
### 동시 수행
- 동시성(Concurrency): 논리적
- 병렬성(Parallelsim):  물리적

### 분산 시스템의 자원 공유
- 동기성 관점이 중요하다.:
  - 타이밍 가정이 있다면 타임아웃과 재시도 기능을 사용할 수 있다.
- 장애 모델(Failure Model)
- 내결함성(Fault Tolerance):
  - 단일 장애 지점을 제거해야한다.
  - 복사본의 동기화 문제를 해결해야한다.

### 분산 컴퓨팅의 오류
- 대부분의 경우 네트워크 신뢰 가정이 있다.
- 네트워크는 불안정하다. 데이터베이스에서는 이런 시나리오도 극복할수 있어야한다.
- 레이턴시에 가정은 최소화하되, 0이라 가정하면 안된다.

### 프로세싱
- 로컬 큐를 사용하는 이유:
  - 분리: 메시지 수신과 처리를 시간적으로 분리하고 독립적으로 수행한다.
  - 파이프라이닝: 서로 다른 단계에 있는 요청은 각각 독립된 서브시스템이 처리한다.
  - 일시적 급증 부하처리

### 클럭과 시간
- 분산시스템에서 클럭 동기화는 쉽지 않다.
- 단조 클럭인지 아닌지 확인 해야한다.

### 상태 일관성
- 분산 알고리즘은 상태에 대한 일관성을 완벽하게 보장하지 않는다.
- 충돌해결과 읽기 중 데이터 복구 방식을 통해 상태 차이를 해결한다.
- 결과적 일관성을 보장하는 분산 시스템에서는 읽기 중에 노드 쿼럼을 쿼리해서 복제 노드 사이의 상태 불일치를 해결하는 로직이 있을 수 있다.

### 로컬 실행과 원격 실행
- 원격 API 뒤에 복잡한 로직을 숨기는 것은 위험할 수 있다.
- 일관성과 전달 방식, 데이터 조정, 페이징, 병합, 동시 접근 등 여러 부분에 관한 이해가 필요하다.
- 원격 실행을 감추기 어려운 이유는 레이턴시이다.

### 장애 처리
- 모든 노드가 정상적으로 작동하지 않는 것을 고려해야한다.
- 원격 서버가 응답하지 않는 이유를 항상 알수는 없다.:
  - 충돌, 네트워크 장애, 원격 프로세스 또는 링크의 속도 저하
  - 하트비트 프로토콜과 장애 검출기를 사용해야한다.

### 네트워크 파티션과 부분 장애
- CAP 정리
- cf. PACELC 정리
- 시스템 장애는 언젠가는 발생한다.
- 모든 장애를 예방하는 것은 불가능하지만 장애가 발생해도 정상적으로 작동하는 탄력적인 시스템은 구축할 수 있다.
- 테스트 하네스를 준비하여:
  - 파티션 생성, 비트 손상 시뮬레이션, 레이턴시 증가, 클럭 불일치 유발, 상대적 처리 속도 증가 등을 테스트할수 있어야한다.

### 계단식 장애
- 지터를 포함한 백오프
- 부하와 핫스팟을 미리 계획하고 조정해야한다.
- 회로 차단기와 백오프 전략, 유효성 검증 및 조정 메커니즘을 구현해야한다.

## 분산 시스템 추상화
### 링크
- 손실될 수 있는 링크:
  - 손실 허용성: 송신자와 수신자가 정확하다면 송신자가 무한정 재전송한 메시지는 결과적으로 전달된다.
  - 유한 중복성: 메시지는 무한히 중복 전달 되지 않는다.
  - 생성 불가성: 링크는 메시지를 생성하지 않는다. 즉, 전송되지 않은 메시지가 전달될 수 없다.
- 메시지 확인 응답
- 메시지 재전송
- 재전송 문제
- 메시지 순서
- (이상적) 퍼팩트 링크:
  - 전송 신뢰성, 전송 비중복성, 생성 불가성
- 정확히 한 번 전달:
  - 모든 노드가 공통 정보를 공유해야 한다.
- 두장군 문제
- FLP 불가능성 이론:
  - 합의 프로토콜의 속성:
    - 일치성: 프로토콜의 결과는 모두가 동의해야한다. 각 프로세스는 특정 값을 선택하고 모든 프로세스의 값은 일치해야 한다. 일치하지 않으면 합의는 실패한다.
    - 유효성: 결정된 값은 특정 프로세스가 제안한 값이다. 시스템이 임의의 값을만들어 낼수 없다는 의미이다. 이는 값은 자명하지 않다는 것을 의미한다. 프로세스는 미리 정의된 같은 기본값을 선택하지 않아야 한다.
    - 유한성: 합의는 오직 모드 ㄴ프로세스가 확정된 상태가 됬을때 유효하다.
- 시스템 동기성:
  - 효율적인 비동기 알고리즘 설계는 쉽지 않고 일부 문제의 가장 실용적인 해결 방안은 시간에 의존할 가능성이 높다.
  - 동기 시스템:
    - 타이밍의 개념을 도입하여
    - 전송 지연 시간은 제한되며, 메시지 전송은 무한대로 오래 걸릴 수 없다고 가정한다.
    - 동기 시스템은 프로세스별로 동기화된 클럭이 있다고 생각할 수 있다.
    - 이러면서 타임아웃을 사용할 수 있게 된다.
  - 래프트 합의 알고리즘에서 일부 프로세스의 속도를 의도적으로 늦춰 특정 프로세스를 리더로 만들 수 있다.
- 부분 동기 모델:
  - 동기 시스템의 일부 속성을 내재하지만, 메시지 전달 시간과 클럭 차이, 상대적 처리 속도의 범위는 다를 수 있다.
- 장애 모델:
  - 충돌:
    - 충돌 정지 모델: 복구를 시도하지 않거나 막지 않는다. 정확성과 라이브니스를 보장하지 않음을 의미한다.
    - 충돌 복구 모델:
      - 모든 가능한 복구 상태를 고려해야한다.
      - 누락 장애 모델
  - 누락:
    - 프로세스가 알고리즘의 단계 중 일부를 건너뛰거나 수행할 수 없는 상태이거나, 다른 참가자가 실행 여부를 알수 없거나 참가자가 서로 메시지를 교환할 수 없는 상태를 설명한다.
    - 처리속도가 늦으면, 다른 프로세스 관점에서는 누락된것 처럼 보일수 있다.
    - 간헐적 연결 끊김과 네트워크 과부하, 큐 공간 부족 등으로 인해 발생할 수도 있다.
- 임의의 장애:
  - 소프트웨어 버그 또는 알고리즘의 버전 차이로 발생하기 쉽다.
  - 비잔티움 장애 허용은 모든 응답을 그대로 신뢰하지 않는다.
- 장애 처리:
  - 다중화를 하면 장애 발생 사실을 숨길 수 있다.
  - 장애는 성능 저하의 요인이 될수 있다.

## 9장 장애 감지
- 장애 감지 알고리즘의 속성:
  - 완전성: 장애 발생시 모든 정상 프로세스는 장애 발생 사실을 인지하고 알고리즘 수행을 완료해 결과를 반환해야한다.
  - 효율성: 얼마나 빨리 장애를 감지할 수 있는지
- 원자적 브로드캐스트 알고리즘의 필수 조건

### 하트비트와 핑
- 원격 프로세스에 메시지를 보내는 핑을 발동 시켜 원격 프로세스가 일정 시간 내에 응답하는지 확인한다.
- 인근 프로세스에 자신의 활성 상태를 알릴 수 있는 하트비트를 전송한다.

### 타임아웃이 없는 장애 감지
- 하트비트 알고리즘은 타임 아웃을 사용하지 않고 하트비트 전송횟수를 기록한다.
- 비동기 시스템에서만 사용할 수 있다.
- 페어링크, 페어 패스로 연결됐고 모두 서로 알고 있다고 가정한다.
- 시스템의 글로벌 뷰라고 볼수 있다.

### 하트비트 아웃소싱
- SWIM 프로토콜(Scalable Weakly Consistent Infection-style Process Group Membership Protocol)
- 구성원 사이에 책임을 나눔으로써 장애 감지의 신뢰성을 높인다.
- 메시지를 광범위한 피어 그룹에 브로드캐스트하지 않아도 된다.

### 파이 누적 장애 감지
- 모니터링 프로세스: 핑과 하트비트 사용 또는 요청-응답 샘플링을 통해 노드의 라이브니스를 확인한다.
- 판정 프로세스: 프로세스를 비정상 상태로 표시해야 하는지 여부를 결정한다.
- 액션 프로세스: 프로세스가 비정상 상태로 판정됐을 때마다 하는 콜백 작업
- 카산드라와 아카

### 가십과 장애 감지
- 각 노드는 전체 노드 목록과 각 노드의 하트비트 카운터 그리고 마지막으로 카운터가 증가된 시간을 나타내는 타임스탬프 값을 저장한다.
- 노드는 주기적으로 다른 노드의 상태와 카운터를 확인한다.
- 충돌한 노드 뿐만 아니라 다른 노드에서 연결할 수 없는 노드까지 찾을 수 있다.

### 장애 전파를 사용한 문제 해결
- FUSE(Failure Notification Service)
- 모든 활성 프로세스를 여러 그룹으로 나눈다.
- 연결 끊김과 네트워크 파티션 노드 장애를 감지할 수 있다.
- 모든 노드는 그룹 내 장애 발생 사실을 알 수 있고 적절하게 대응할 수 있다.
- 링크 장애로 인해 한 개의 프로세스가 분리돼도 그룹 전체의 장애로 확장된다.

